<tool id="scvis_train" name="SCVIS train" version="0.1.0">
    <description>Parametric alternative to t-SNE for use in high-dimensional data analysis.</description>
    <requirements>
        <requirement type="package" version="0.1.0">scvis</requirement>
        <requirement type="package" version="1.13">tensorflow</requirement>
    </requirements>
    <command detect_errors="aggressive"><![CDATA[
scvis train --data_matrix_file '${datafile}'
#if $datalabel:
    --data_label_file '${datalabel}'
#end if
#if $plots:
    --show_plot
#end if
#if $configfile:
    --config_file '${configfile}'
#end if
#if $norm.normalize == "Yes":
    --normalize '${norm.normal}'
#end if
--verbose
&& mkdir plots
&& mkdir tsv
&& mv output/*.tsv tsv
&& mv output/*.png plots
#if $plots:
    && mv output/*result/*.png plots
#end if
    ]]></command>
    <inputs>
        <param name="datafile" type="data" format="tsv, tabular" label="Data Matrix File" help="Data matrix with first row as the column names"/>
        <param name="datalabel" type="data" format="tsv, tabular" label="Optional Data Label File" optional="true" help="One column file with header provinding corresponding cluster information for each data point. Used for coloring plots."/>
        <param name="plots" type="boolean" checked="false" optional="true" label="Retrieve training graphs?" truevalue="true" falsevalue="false" />
        <param name="configfile" type="data" format="yaml" optional="true" label="Optional Config File" help="Config yaml file as specified in the scvis docs"/>
        <conditional name="norm">
            <param name="normalize" type="select" label="Set Normalization Value?" help="If not selected, normalization will use maximum absolute value">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
            </param>
            <when value="No"/>
            <when value="Yes">
                <param name="normal" type="float" value="0.5" label="Normalization value" help="A positive float"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
      <collection name="graphs" type="list" label="Final graphical outputs">
          <discover_datasets pattern="__designation__" format="png" directory="plots" visible="false"/>
      </collection>
      <collection name="tsv" type="list" label="Final tsv outputs">
          <discover_datasets pattern="__designation__" format="tabular" directory="tsv" visible="false"/>
      </collection>
    </outputs>
    <tests>
        <test expect_num_outputs="2">
            <param name="datafile" value="synth.tsv"/>
            <param name="datalabel" value="synthlabel.tsv"/>
            <param name="configfile" value="configtest.yaml"/>
            <param name="normalize" value="Yes"/>
            <param name="normal" value="0.5"/>
            <assert_stdout>
                <has_text_matching expression="scaled_tsne_cost:"/>
            </assert_stdout>
            <output_collection name="tsv" type="list">
                <element name="perplexity_10_regularizer_0.001_batch_size_512_learning_rate_0.01_latent_dimension_2_activation_ELU_seed_1_iter_3000_log_likelihood.tsv" file="log_likely.tsv" ftype="tabular"/>
            </output_collection>
            <output_collection name="graphs" type="list">
                <element name="perplexity_10_regularizer_0.001_batch_size_512_learning_rate_0.01_latent_dimension_2_activation_ELU_seed_1_iter_3000_log_likelihood.png" file="log_likely.png" ftype="png"/>
            </output_collection>
        </test>
        <test expect_num_outputs="2">
            <param name="datafile" value="synth.tsv"/>
            <param name="datalabel" value="synthlabel.tsv"/>
            <param name="plots" value="true"/>
            <output_collection name="graphs" type="list" count="63">
                <element name="embedding_iter_00000.png" file="training_graph.png" ftype="png" compare="sim_size"/>
            </output_collection>
        </test>
        <test expect_num_outputs="2">
            <param name="datafile" value="synth2.tsv"/>
            <param name="datalabel" value="synthlabel2.tsv"/>
            <param name="configfile" value="configtest.yaml"/>
            <assert_stdout>
                <has_text_matching expression="elbo:"/>
            </assert_stdout>
            <output_collection name="tsv" type="list">
                <element name="perplexity_10_regularizer_0.001_batch_size_512_learning_rate_0.01_latent_dimension_2_activation_ELU_seed_1_iter_4300_obj.tsv" file="obj.tsv" ftype="tabular"/>
            </output_collection>
            <output_collection name="graphs" type="list">
                <element name="perplexity_10_regularizer_0.001_batch_size_512_learning_rate_0.01_latent_dimension_2_activation_ELU_seed_1_iter_4300_obj.png" file="obj.png" ftype="png"/>
            </output_collection>
        </test>
    </tests>
    <help><![CDATA[
This tool is for the initial training of the model and clustering graphs. To add data to your model, use SCVIS map.
    ]]></help>
    <citations>
        <citation type="doi">10.1038/s41467-018-04368-5</citation>
    </citations>
</tool>
